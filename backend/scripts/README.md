# Backend Code Generation Scripts

This directory contains automated scripts for extracting types and API endpoints from the backend, ensuring type safety and consistency across your fullstack application.

## Scripts Overview

- **extract-types.js**: Extracts DTO types and enums as TypeScript interfaces
- **extract-endpoints.js**: Generates API endpoint constants with parameter support
- **test-extraction.js**: Tests the extraction process locally before pushing to GitHub

## DTO Type Extraction System

This system automatically extracts TypeScript interfaces from backend DTOs and makes them available to the frontend, ensuring type safety across your fullstack application.

## How It Works

1. **Extraction Script**: `extract-types.js` scans all `.dto.ts` files in the backend
2. **Transformation**: Removes NestJS decorators and converts classes to clean interfaces
3. **Output**: Generates TypeScript interface files in `web/src/types/generated/`
4. **Integration**: Runs automatically during backend build process

## Usage

### Automatic Generation

**Development Mode (Recommended):**

```bash
cd backend
npm run dev             # Starts NestJS + automatic type watching
npm run watch-types     # Watch for DTO changes only
```

**Build Mode:**

```bash
cd backend
npm run build          # Extracts types + builds backend
npm run extract-types  # Extract types only (one-time)
```

### In Frontend Code

Import generated types in your React components:

```typescript
// Import specific types
import { CreateUserDto, LoginDto } from '../types/generated';

// Import all types
import * from '../types/generated';

// Use in API calls
const login = async (credentials: LoginDto) => {
  const response = await fetch('/auth/login', {
    method: 'POST',
    body: JSON.stringify(credentials)
  });
  return response.json();
};
```

### Type Safety Benefits

- **Shared contracts**: Frontend and backend use identical type definitions
- **Compile-time errors**: TypeScript catches mismatched API calls
- **Auto-completion**: Full IDE support for API request/response types
- **Refactoring safety**: Backend changes automatically propagate to frontend
- **Hot reloading**: Types regenerate automatically during development
- **Real-time feedback**: Instant type updates when DTOs change

## File Structure

```
backend/
├── src/
│   ├── auth/dto/
│   │   ├── login.dto.ts           # Source DTO
│   │   └── login-response.dto.ts
│   └── user/dto/
│       ├── create-user.dto.ts
│       └── get-user.dto.ts
└── scripts/
    └── extract-types.js           # Extraction script

web/
└── src/
    └── types/
        └── generated/             # Auto-generated (gitignored)
            ├── index.ts           # Re-exports all types
            ├── auth/dto/
            │   ├── login.types.ts
            │   └── login-response.types.ts
            └── user/dto/
                ├── create-user.types.ts
                └── get-user.types.ts
```

## What Gets Transformed

### Before (Backend DTO)

```typescript
import { IsString, IsEmail } from 'class-validator';

export class CreateUserDto {
  @IsString()
  public readonly name: string;

  @IsEmail()
  public readonly email: string;
}
```

### After (Generated Frontend Interface)

```typescript
// Auto-generated from user/dto/create-user.dto.ts
// Do not edit this file manually

export interface CreateUserDto {
  name: string;
  email: string;
}
```

## Development Workflow

### Recommended Development Flow

1. **Start Development**: Run `npm run dev` in backend (starts NestJS + type watcher)
2. **Update Backend DTO**: Modify any `.dto.ts` file
3. **Types Auto-Regenerated**: File watcher automatically detects changes and regenerates types
4. **Use in Frontend**: Import and use the updated types immediately
5. **Type Safety**: TypeScript will catch any breaking changes in real-time

### Manual Build Flow

1. **Update Backend DTO**: Modify any `.dto.ts` file in backend
2. **Test Extraction**: Run `npm run test-extraction` to verify everything works
3. **Build Backend**: Run `npm run build` or `npm run extract-types`
4. **Use in Frontend**: Import and use the updated types
5. **Type Safety**: TypeScript will catch any breaking changes

## File Watcher Features

The automatic type regeneration includes:

- **Smart Detection**: Monitors all `.dto.ts` files recursively
- **Debounced Execution**: Prevents multiple regenerations from rapid changes
- **Error Handling**: Shows clear error messages for syntax issues
- **Cross-Platform**: Works on Windows, macOS, and Linux
- **Development Integration**: Runs alongside NestJS development server
- **Graceful Shutdown**: Clean exit with Ctrl+C

### Watcher Commands

```bash
npm run dev             # NestJS + Type watcher (recommended)
npm run watch-types     # Type watcher only
npm run start:dev       # NestJS only (no type watching)
```

## Alternative Approaches

If this approach doesn't fit your needs, consider:

- **Shared NPM Package**: Create separate package for shared types
- **Monorepo Workspaces**: Use npm/yarn workspaces for shared dependencies
- **Manual Sync**: Copy types manually (not recommended)
- **GraphQL**: Use GraphQL with code generation

## Troubleshooting

### Types Not Updating

- Ensure you run `npm run extract-types` after changing DTOs
- Check that the backend build process includes type extraction
- Verify generated files exist in `web/src/types/generated/`

### Import Errors

- Use relative imports: `'../types/generated'`
- Check that the generated index.ts exports the types you need
- Ensure TypeScript can resolve the generated paths

### Complex DTOs

- The script handles basic transformations
- For complex inheritance or generics, you may need to enhance the extraction logic
- Consider using a proper AST parser for advanced cases

---

## API Endpoint Extraction System

This system automatically scans NestJS controllers and generates API endpoint constants for the frontend, providing type-safe URL building with parameter support.

### How It Works

1. **Controller Scanning**: `extract-endpoints.js` finds all `.controller.ts` files in the backend
2. **Endpoint Extraction**: Parses HTTP decorators (`@Get`, `@Post`, etc.) and their paths
3. **URL Generation**: Creates constants for simple endpoints and functions for parameterized routes
4. **Output**: Generates `web/src/types/generated/api-endpoints.ts` with organized API constants

### Usage

**Manual Generation:**

```bash
cd backend
npm run extract-endpoints  # Generate endpoint constants
```

**Automatic Integration (Recommended):**

Add to your build process or development workflow.

### Generated Output

The script generates a comprehensive API object with all your endpoints:

```typescript
// Auto-generated from controllers
export const API = {
  // Root endpoints
  ROOT: '/',

  // Auth endpoints
  POST_AUTH_LOGIN_V1: '/auth/login/v1',
  POST_AUTH_REFRESH_V1: '/auth/refresh/v1',
  POST_AUTH_LOGOUT_V1: '/auth/logout/v1',
  AUTH_VERIFY_V1: '/auth/verify/v1',

  // Users endpoints
  POST_USERS_V1: '/users/v1',
  USERS_ME_V1: '/users/me/v1',

  // Projects endpoints (parameterized)
  POST_PROJECTS_V1: '/projects/v1',
  PROJECTS_ID_V1: (id: string) => `/projects/${id}/v1`,
  PROJECTS_OWNERS_OWNERID_V1: (ownerId: string) => `/projects/owners/${ownerId}/v1`,
  PROJECTS_CUSTOMERS_CUSTOMERID_V1: (customerId: string) => `/projects/customers/${customerId}/v1`,
} as const;

// Type definitions
export type ApiEndpoints = typeof API;
export type EndpointParams<T> = T extends (...args: infer P) => string ? P : never;
```

### Frontend Usage

Import and use the generated API constants in your frontend code:

```typescript
import { API } from '@/types/generated/api-endpoints';

// Simple endpoints
const loginResponse = await fetch(API.POST_AUTH_LOGIN_V1, {
  method: 'POST',
  body: JSON.stringify(credentials),
});

const userProfile = await fetch(API.USERS_ME_V1);

// Parameterized endpoints
const projectId = '123';
const projectData = await fetch(API.PROJECTS_ID_V1(projectId));

const ownerId = 'user-456';
const ownerProjects = await fetch(API.PROJECTS_OWNERS_OWNERID_V1(ownerId));
```

### Benefits

- **Type Safety**: All endpoint URLs are type-checked at compile time
- **Parameter Validation**: Functions ensure required parameters are provided
- **Autocomplete**: Full IDE support for endpoint discovery
- **Refactoring Safety**: URL changes in controllers automatically update frontend
- **Central Management**: All API endpoints in one organized location
- **Documentation**: Self-documenting API surface area

### What Gets Extracted

The script extracts from NestJS controllers:

**Controller Class:**

```typescript
@Controller('projects')
export class ProjectController {
  @Get('/:id/v1')
  async findById(@Param('id') id: string) { ... }

  @Get('/owners/:ownerId/v1')
  async findByOwnerId(@Param('ownerId') ownerId: string) { ... }
}
```

**Generated Constants:**

```typescript
export const API = {
  PROJECTS_ID_V1: (id: string) => `/projects/${id}/v1`,
  PROJECTS_OWNERS_OWNERID_V1: (ownerId: string) => `/projects/owners/${ownerId}/v1`,
} as const;
```

### File Structure

```
backend/
├── src/
│   ├── auth/auth.controller.ts       # Source controller
│   ├── user/user.controller.ts
│   ├── project/project.controller.ts
│   └── app.controller.ts
└── scripts/
    └── extract-endpoints.js          # Extraction script

web/
└── src/
    └── types/
        └── generated/
            └── api-endpoints.ts       # Auto-generated endpoints
```

### Naming Convention

The script generates constant names following this pattern:

- **Simple endpoints**: `{METHOD}_{PATH}_PARTS` (e.g., `POST_AUTH_LOGIN_V1`)
- **GET endpoints**: Method prefix omitted (e.g., `USERS_ME_V1` instead of `GET_USERS_ME_V1`)
- **Root endpoint**: Special case named `ROOT`
- **Parameters**: Converted to function parameters (e.g., `:id` becomes `(id: string)`)

### Integration with Build Process

Add to your package.json scripts:

```json
{
  "scripts": {
    "build": "npm run extract-types && npm run extract-endpoints && nest build",
    "extract-endpoints": "node scripts/extract-endpoints.js",
    "dev": "concurrently \"npm run watch-types\" \"npm run start:dev\"",
    "prebuild": "npm run extract-types && npm run extract-endpoints"
  }
}
```
